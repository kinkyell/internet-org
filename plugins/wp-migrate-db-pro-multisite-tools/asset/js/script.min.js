var wpmdb=wpmdb||{};wpmdb.mst={remote_mst_unavailable:!1},function(a,b){function c(){return"1"===v.attr("data-available")&&v.is(":checked")?!0:!1}function d(){a.wpmdb.do_action("wpmdb_lock_replace_url",!1),a.wpmdb.do_action("wpmdb_enable_table_migration_options"),v.attr("data-available","0"),v.prop("checked",!1),v.attr("disabled","disabled"),a(".mst").addClass("disabled"),w.hide()}function e(){v.attr("data-available","1"),v.removeAttr("disabled"),a(".mst").removeClass("disabled")}function f(f){return"false"===wpmdb_data.site_details.is_multisite?(d(),void u.hide()):"savefile"!==wpmdb_migration_type()&&"undefined"!=typeof b.mst.remote_connection_data&&"true"===b.mst.remote_connection_data.site_details.is_multisite?(d(),void u.hide()):"savefile"!==wpmdb_migration_type()&&!1===f&&"undefined"!=typeof b.mst.remote_connection_data&&"undefined"!=typeof b.mst.remote_connection_data.site_details&&wpmdb_data.site_details.prefix!==b.mst.remote_connection_data.site_details.prefix?(d(),m(!1),a(".mst-remote-location").html(b.mst.remote_connection_data.url),a(".mst-remote-prefix").html(b.mst.remote_connection_data.site_details.prefix),void E.show()):(E.hide(),f&&"true"===wpmdb_data.site_details.is_multisite&&"savefile"!==wpmdb_migration_type()?(d(),m(!1),void C.show()):(C.hide(),"savefile"!==wpmdb_migration_type()&&"undefined"!=typeof b.mst.remote_connection_data&&wpmdb_data.mst_version!==b.mst.remote_connection_data.mst_version?(d(),m(!1),a(".mst-remote-location").html(b.mst.remote_connection_data.url),a(".mst-remote-version").html(b.mst.remote_connection_data.mst_version),void D.show()):(D.hide(),e(),c()?(w.show(),k()):w.hide(),g(),void u.show())))}function g(){c()&&"savefile"!==wpmdb_migration_type()?a.wpmdb.do_action("wpmdb_lock_replace_url",!0):a.wpmdb.do_action("wpmdb_lock_replace_url",!1)}function h(){if(""===x.val())return void y.hide();if("savefile"!==wpmdb_migration_type()){z.hide(),B.show(),y.children("label").addClass("disabled");var a=I,b=j();"pull"===wpmdb_migration_type()&&void 0!==b.blog_id&&1<b.blog_id&&(a=a+b.blog_id+"_"),z.val(a),A.val(a),B.text(a)}else z.show(),B.hide(),y.children("label").removeClass("disabled");y.show()}function i(){var b=c();g(),a.wpmdb.do_action("wpmdbmst_select_subsite_changed",b)}function j(){var a={};if(c()){var b=x.find("option:selected").val();""===b?a=!1:(a.blog_id=b,a.domain_and_path=x.find("option:selected").text())}return a}function k(){var b=j();a.wpmdb.do_action("wpmdbmst_selected_subsite_changed",b)}function l(b){a.wpmdb.do_action("wpmdb_refresh_table_selects"),"pull"===wpmdb_migration_type()?a.wpmdb.do_action("wpmdb_update_pull_table_select"):a.wpmdb.do_action("wpmdb_update_push_table_select"),c()?(a.wpmdb.do_action("wpmdb_disable_table_migration_options"),F&&(!1===J||void 0!==J.blog_id&&void 0!==b.blog_id&&J.blog_id!==b.blog_id)&&a.wpmdb.do_action("wpmdb_select_all_tables")):a.wpmdb.do_action("wpmdb_enable_table_migration_options"),J=b}function m(b){var c=G;if(void 0!==b){void 0!==b.domain_and_path&&(c="//"+b.domain_and_path);var d=!1;"pull"===wpmdb_migration_type()&&(d=!0),H&&(d=!d),d?a('.replace-row.pin .replace-right-col input[type="text"]').val(c):a('.replace-row.pin .old-replace-col input[type="text"]').val(c)}}function n(a,c){var d=j();if(void 0!==d.blog_id){if(!(1<d.blog_id)){var e=b.preg_quote(c),f=new RegExp(a+"([0-9]+)_","i"),g=f.exec(e);return null==g}a=a+d.blog_id+"_";var h=c.toLowerCase().indexOf(a.toLowerCase());if(0===h)return!0}return!1}function o(d,e){if("false"===wpmdb_data.site_details.is_multisite)return d;if(c()){if(!1===j())return!0;if(e.substr(0,I.length)!==I)return!0;if("pull"===wpmdb_migration_type()&&"undefined"!=typeof b.mst.remote_connection_data&&"true"!==b.mst.remote_connection_data.site_details.is_multisite)return d;if(b.table_is(I,"users",e)||b.table_is(I,"usermeta",e))return d;var f=["blog_versions","blogs","registration_log","signups","site","sitemeta"];a.each(f,function(a,c){b.table_is(I,c,e)&&(d=!0)}),!1===n(I,e)&&(d=!0)}return d}function p(a){var c=b.preg_quote(a),d=new RegExp("[^a-z0-9_]","i"),e=d.exec(c);return null==e}function q(a,b){if("false"===wpmdb_data.site_details.is_multisite||!1===c())return a;var d=z.val();return!1===j()?(alert(wpmdbmst_strings.please_select_a_subsite),a=!1):0===d.trim().length?(alert(wpmdbmst_strings.please_enter_a_prefix),a=!1):!1===p(d)&&(alert(wpmdbmst_strings.new_prefix_contents),a=!1),a}function r(d){if(c()){var e=j();void 0!==e.blog_id&&1<e.blog_id&&("false"===wpmdb_data.site_details.is_multisite||"true"!==b.mst.remote_connection_data.site_details.is_multisite)&&a.each(d,function(a,c){!1===b.table_is(I,"users",c)&&!1===b.table_is(I,"usermeta",c)&&(!1===n(I,c)&&("pull"===wpmdb_migration_type()&&"true"===wpmdb_data.site_details.is_multisite||"push"===wpmdb_migration_type()&&"true"===b.mst.remote_connection_data.site_details.is_multisite)&&(d[a]=z.val()+c.substr(I.length)),!0===n(I,c)&&("pull"===wpmdb_migration_type()&&"false"===wpmdb_data.site_details.is_multisite||"push"===wpmdb_migration_type()&&"true"!==b.mst.remote_connection_data.site_details.is_multisite)&&(d[a]=z.val()+c.substr((I+e.blog_id+"_").length)))})}return d}function s(a){return!1!==a&&c()&&(a=!1),a}function t(a){b.mst.remote_connection_data=a,b.mst.remote_mst_unavailable="undefined"==typeof a.mst_available}var u=a(".mst-options"),v=a("#mst-select-subsite"),w=a(".mst-options .expandable-content"),x=a("#mst-selected-subsite"),y=a(".new-prefix-field"),z=a("#new-prefix"),A=a("#new-prefix-hidden"),B=a("#new-prefix-readonly"),C=a(".mst-unavailable"),D=a(".mst-different-plugin-version-notice"),E=a(".mst-different-prefix-notice"),F=!1,G=null,H=!1,I=a(".table-select-wrap .table-prefix").text(),J=!1;a.wpmdb.add_action("move_connection_info_box",function(c){I=a(".table-select-wrap .table-prefix").text(),null===G&&(G=a.wpmdb.apply_filters("wpmdb_base_old_url")),void 0!==c.migration_type&&void 0!==c.last_migration_type&&(c.migration_type===c.last_migration_type||"pull"!==c.migration_type&&"pull"!==c.last_migration_type||(H=!0)),wpmdb_toggle_migration_action_text(),f(b.mst.remote_mst_unavailable),a.wpmdb.do_action("wpmdb_refresh_table_selects"),H&&(H=!1)}),a.wpmdb.add_action("verify_connection_to_remote_site",function(a){t(a),f(b.mst.remote_mst_unavailable)}),a.wpmdb.add_action("wpmdbmst_select_subsite_changed",k),a.wpmdb.add_action("wpmdbmst_selected_subsite_changed",l),a.wpmdb.add_action("wpmdbmst_selected_subsite_changed",m),a.wpmdb.add_action("wpmdbmst_selected_subsite_changed",h),a.wpmdb.add_action("wpmdb_connection_data_updated",t),a.wpmdb.add_filter("wpmdb_exclude_table",o),a.wpmdb.add_filter("wpmdb_migration_profile_ready",q),a.wpmdb.add_filter("wpmdb_backup_selected_tables",r),a.wpmdb.add_filter("wpmdbmf_enable_select_subsites",s),a(document).ready(function(){a("body").on("change","#mst-select-subsite",function(a){i()}),a("body").on("change","#mst-selected-subsite",function(a){k()}),f(b.mst.remote_mst_unavailable),F=!0})}(jQuery,wpmdb);